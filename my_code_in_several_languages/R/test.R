


#удаление всех переменных
rm(dd,ddd,k,maxx,mm,rebro,rebro2,alef,dann,error,error2,i,j,mass,mass2,mmpro,mmpro2,mz,proizv3,rpro3,mmm)
rm(ii,kol_neir,kol_reb,kol_ver,len,ll,str,neir_str,reb,zn_r,kol_step,k_step,a,alef2,rebro3,error3,mass3,mmpro3)
rm(nastr,neir,proizv,proizv2,razn_iz,razn_must,rpro,rpro2,summm,summr,vect_m,vect_r,sigma,vx,vix,step,mmv,zz)
rm(dd_all,dd_new,minn,nnn,prog,progn,prog_ogr,dd_prog,z,mm_old,iz_old,kmm_old,neir_old,neir_,r)
rm(kk,kk2,m,m2,mx,mx2,r2,all_time,b_err,neir2,neir3,tm,tm_beg,z_step)
rm(d,M,Mp,Mq2,Mqй,Mqr,Mqrr,Mq,t)

rm(db,dd_all,dd_prog,progn,alef,dirName,dn_k,error,fr,fr_n,k_f,list_c,list_f,sigma,zz)
rm(modelBinaries,modelDescriptions,modelIds)

rm(by,by_,dann_,dann_2,dann_h,df1,df2,dh,dh_,dh2,sm,sm_,smm,tmp,un,un_,unn,unn_,sm_napr,dn_,dh_1,dann_1)  
rm(dann,dd,ddd,before,by_day,dann.Date,dann_.Date,dt,hist,i,ii,k,k_x,l,max_date,name,sm_Napr,plus_napr,xx,dn)  

rm(pData_,mr,mr_,mr2,extdb,mData,mData_,mt2,pData,result,result_,seldb,wData)
rm(dbName,dbPath,extdbName,mData.list,rbefore,cnames,dates,dList,h,lastDate,length,name,plus_napr)
rm(tp,tr,trains,types,extractor,viborka,init_dann_frame,dt_,dop,bad_dist,bad_k)

rm(dd_all,maxx,mm,mm_,dn_k,iz_old,j,len,dd_prog,progn,zz,alef,error,type,sigma,dann,ddd,dn,k,dann_)
rm(dh,dh_,dh2,sm,sm_,by,by_,i,max_date,min_date,ddd_,dann_.Date,l,m,xx,rr,perebor,ssozd)

rm(dannie1,mar,matrix,rawdb,rawdb_m,rawdb_p,rawdb1,rawdb2,rawdb3,tmp,tmp_m,tmp_p,date,dbName)
rm(dt,i,name,name_mar,p,pp,rst,sto_,stn_,tmo_,tmp_,tr,train,zz,ff,h,hh,f,z,max_dat,max_dats,dann,ufilter,new.data_)
rm(aggrdb,aggrdb_,aggrdb_mar,info,matrix_mar,new_data,new.data,new.files,pass,dbPath,kol_zap)
rm(file,filePath,files,first,format,mm,path,aggregator,filter,init_dann_frame,updater,new,new_)
rm(mar_,mar_2,mar_dt,mar_na,matr,matrix_,raw,rez,rez1,rez2,tmp1,tmp2,by,by1,by2,mar_pzd,testDF,xx)
rm(dd_all,maxx,mm_old,iz_old,j,kmm_old,len,str,yy,dat,dat_,year,yy_,err1,err2,dats,prazd,m1,max_d,min_d)

rm(neir_h,neir_hist,neir_hist_,neir_s,neir_sokr,neir2_s,sozd,id,list,neir_hist_sokr,neir_pack,neir1)
rm(neir_progn,neir_progn_old,idd,idd_,by_time,neir_progn_,progn_p,bd,pn,Type_,fby1,fby2,dd_prog_,nn,nn_,infoPath)
rm(names,fvh,kol_h,list_days,svh,vh,vh_,vh_i,nh,pack,pr,vozm,bef_end,id_ord,mt,prg,zz_,progn_,days)
rm(blok,blok_len,neir_hist_blok,cl,cores,kol_blok,neir_block,neir_blok,neirs,neirs_,clust,neir_hist_s)
rm(list_id,max_id,skor,skors,befores,mprogn,mzz,names_dat,nm,zd,bg,day_f,stroka,neir_hist_s_,nr,l_k)
rm(list_k,mon,mons,ord,pack_,marshr,rst_o,rst_n,max_rst,kol_mest,mesta,kp,max_n,cena,stoim,mrst,sel)
rm(df,vibor,coef,columns,kol,pole,ps,rows,s,spis,x.0,y,y1,y2,fun1,fun2,fun3,sh,sh_,shema,ns,k_povtor,Train,vhod)  
rm(sozd_,szd,pts,zn,zzn,progn_new,progn_new_,progn_z,prov,prov_,prover,min_pr,max_dt,prognoz_itogi)
rm(prognoz_itogi_old,prognoz_itogi_sr,srok,vid,dann2,pas,vag,kol_m,b,progn_itog,progn_itog_,shema_)
rm(best,neir_hist_s_2,neir_hist_s2,best,max_pr,best_,bad,years,ye,info_,min_dat,max_dat_pr,old_rez,names2)
rm(rezult,rezult_,rez_,pd,pd_,arenda,rezz,nm2,summir,rezult_s,tip,tip_n,tipp,nm_,str_,tip_all)
rm(pars,rez_dann,tab,tip_prog,params,tip_isp,c,vib,bef,sklei,min_before,max_vhod,max_before,max,Date)
rm(tip_name,pro,vhod_,vibor_,kol_vhod,umn_param,rr_,bef_otp,kx,new_ver,new_vid,pred,vhod_before)
rm(maxx_,mx_,kurs,tip_name_,rz,nom,popitka,itog,col,activ,x,select,stb,dann_tip,mtip,progn_p_,made,tmbeg)
rm(plus,neir_hist_1,vb,vb_,neir_hist_p,min_,max_,func,hist_,x1,x2,n,reb_,reb2,rebb,ispr,rezz_,sver)
rm(dann_hran,hran,tips,max_vh,nam,vhod_zn,hr,min_bef,rez_nn,rez_ss,ta,neir_progn_new,by_core,kpd)
rm(set_id,t_nastr,t_nastr2,dnn,xx_,progn_nm,prognozi,id_,iz)

#rm(myPackage,neural)




###############################################################################
#НАПОЛНЕНИЕ ИСХОДНЫМИ ДАННЫМИ


name='sahalin'

name = 'sapsan'

#ПАССАЖИРЫ запуск сбора данных. по фильтру Сахалин - месячные данные
myPackage$trs.pData.aggregate(name)
#ВАГОНЫ сбора данных. по фильтру Сахалин - месячные данные
myPackage$trs.wData.aggregate(name)


#Наработка данных склеенных таблиц
system.time(myPackage$trs.tData.extract2(name))



#ПАССАЖИРЫ  апдейт суточными данными
myPackage$trs.pData.update(name);
#ВАГОНЫ добавка посуточных данных. по фильтру Сахалин 
myPackage$trs.wData.update(name)


#Наработка данных склеенных таблиц
system.time(myPackage$trs.tData.extract2(name))


#ИНФОРМАЦИЯ О ФАЙЛАХ
info=myPackage$trs.dann_load('info','rez')









#ВЫБОРКА ДАННЫХ ДЛЯ МОЕЙ НЕЙРОСЕТИ
#sozd=data.frame(name='sahalin',before=10,bef_end=10,plus_napr="0",hist='0',by_day=5,
                #Type="К",Skor="",Napr="",First="",Train="",vhod='pkm,Seats',progn='kol_mest',
                #bad_dist=30,bad_k=10,day_f='week,prazd');



#################################
#подготовлены данные для случайной выборки

name='sahalin'
#    dannie=myPackage$trs.dannie_for_neir(name)

min_before=10
#создание случайной нейросети. с ограничением по числу входов и миним запаздыванию
#             max_vhod=3;min_before=10
neir=myPackage$trs.sozd_neir(name,dannie,max_vhod=2,min_before)
neir$k$kol_neir=3 #увеличение объёма нейросети - сколько внутренних нейронов

#собственно подготовка данных, пока без оптимизации процесса подготовки
itog=myPackage$trs.sozd_neir_dann(dannie,neir);dann=itog$dann;neir=itog$neir;rm(itog)

#нормированние и массивы по новому, и инициализация всех параметров нейросети по необходимости
dann_n=neural$normir_dann(neir,dann);
neir=dann_n$neir;ddd=dann_n$dd;dd_all=dann_n$dd_all;rm(dann_n);


  
  #настройка нейросети
  #system.time(nastr<-   neural$neir_nastr(ddd,neir,10))
  system.time(neir<-neural$neir_nastr_new(ddd,neir,10))
  sigma=neir$k$sigma;
  #  neir$k$ogr_k=0.2
  
  progn=neural$neir_prognoz(dd_all,neir);dd_prog=dd_all;dd_prog$z=progn$z;dd_prog$zp=progn$zp;
  #dd_prog=subset(dd_prog, select = c(Train,Date,Type,Seats,y,z,zp));
  #подсчёт итоговых отличий, независимой сверкой
  zz=aggregate(x =list(err= (dd_prog$y-dd_prog$z)**2,col=1),by = list(dd_prog$dann,dd_prog$Train), FUN = "sum")
  zz$sigma=(zz$err/zz$col)**0.5; #получилось хорошо - совпадает!
  #график коррелляции 
  plot (x=dd_prog$y,y=dd_prog$z,col=dd_prog$dann)
  
  
  #запись нейросети в базу истории нейросети, и полную и сокращённую
  neir=neural$neir.save_to_hist(neir,NULL);#запись без прогнозов - не ставит глухую активность!
  
  neir=neural$neir.save_to_hist(neir,dd_all);#запись с прогнозами
  
#    neir$sozd$vhod   ; neir$sozd$vibor ;  neir$rebro
#  neir$rebro[1:12,3]=0;neir$rebro[1,3]=1;neir$rebro[12,3]=-0.5;
#  neir$rebro[38,3]=neir$rebro[38,3]-1
  
  
progn=neural$neir_prognoz_narabot(neir,dd_all) #наработка прогноза  
  
  
  
  
  
  
  
#поиск диапазонов значений входов внутренних нейронов
rezz=neural$neir_vnutri(neir,ddd)
  
  
  
  
  
#прибавить к нейросети входов! Случайным образом. И сразу и данные
#   min_before=10
itog=myPackage$trs.neir_plus_vhod(dannie,neir,min_before) 
dann=itog$dann;neir=itog$neir;rm(itog)

#нормированние и массивы по новому, и инициализация всех параметров нейросети по необходимости
dann_n=neural$normir_dann(neir,dann);
neir=dann_n$neir;ddd=dann_n$dd;dd_all=dann_n$dd_all;rm(dann_n);






##СОЗДАНИЕ МНОЖЕСТВА НЕЙРОСЕТЕЙ НУЖНЫМ МНЕ СПОСОБОМ
prognozi=c('kp','kp.Napr','kol_mest','kol_mest.Napr')
befores=10+(0:10)*3
#создание множества однотипных нейросетей с разными прогнозами и запаздываниями
myPackage$trs.sozd_neir_many(dannie,befores,prognozi) 





#по номеру нейросети возвращает из памяти саму нейросеть
neir=neural$get_neir_id(1)
#  neir$sozd$vhod
  
#собственно подготовка данных, пока без оптимизации процесса подготовки
itog=myPackage$trs.sozd_neir_dann(dannie,neir);dann=itog$dann;neir=itog$neir;rm(itog)

#нормированние и массивы по новому, и инициализация всех параметров нейросети по необходимости
dann_n=neural$normir_dann(neir,dann);
neir=dann_n$neir;ddd=dann_n$dd;dd_all=dann_n$dd_all;rm(dann_n);


#поиск нужного номера
#neir_hist_s=myPackage$trs.dann_load('neiroset','sokr') #чтение списка всех нейросетей
#neir_hist_s=neir_hist_s[(neir_hist_s$activ==1),] #подвыборка активных





#ГЛАВНОЕ - АНАЛИЗ ПРОГНОЗОВ. ТАБЛИЦА ИТОГОВЫХ ПРОГНОЗОВ - ПО НОВОМУ
#     prover=c(30,50,100);     name='sahalin'
prognoz_itogi=neural$prognoz_itogi_new(name='sahalin',prover=c(30,50,100))







#ДООБУЧЕНИЕ ВСЕХ НЕЙРОСЕТЕЙ многократно
vibor=data.frame(name='sahalin')
neural$all_neir_new_podnastr_many(dannie,30,vibor,15) 


#ДООБУЧЕНИЕ ВСЕХ НЕЙРОСЕТЕЙ - В ПАРАЛЛЕЛЬНОМ РЕЖИМЕ
vibor=data.frame(name='sahalin')
neural$all_neir_new_podnastr_parallel(dannie,30,vibor,15) 





#поиск нужного номера
neir_hist_s=myPackage$trs.dann_load('neiroset','sokr') #чтение списка всех нейросетей
neir_hist_s=neir_hist_s[(neir_hist_s$activ==1),] #подвыборка активных

#  myPackage$trs.Data_save(neir_hist_s,'neiroset','sokr',TRUE)  #запись сокращений нейросетей обратно






#история одной нейросети
idd=171
neir_hist_s=myPackage$trs.dann_load('neiroset','sokr') #чтение списка всех нейросетей
neir_hist_s[is.na(neir_hist_s$pred_id),'pred_id']=0
hist=neir_hist_s[(neir_hist_s$id==idd),]
idd=unique(hist$pred_id)
while(idd>0){
  hist_=neir_hist_s[(neir_hist_s$id==idd),];
  hist=rbind(hist,hist_);
  idd=as.integer(unique(hist_$pred_id))
  }






#прогноз за дату на печать, и на график
prognoz_itogi=neural$prognoz_itogi_new(name='sahalin',prover=c(30,50,100))

progn=prognoz_itogi[(prognoz_itogi$Date=='2015-10-10'),]
progn=progn[order(progn$Napr,progn$Train,progn$id,progn$Seats),]

dbPath='d:/prognoz.txt'
 write.csv(x = progn, file = dbPath) 
 
pr=progn[(progn$Train=='0002Э'),]

plot (x=progn$Seats,y=progn$progn, col=progn$Napr)
plot (x=pr$Seats,y=pr$progn)












#по номеру нейросети возвращает из памяти саму нейросеть
neir=neural$get_neir_id(651)

#собственно подготовка данных, пока без оптимизации процесса подготовки
itog=myPackage$trs.sozd_neir_dann(dannie,neir);dann=itog$dann;neir=itog$neir;rm(itog)

#нормированние и массивы по новому, и инициализация всех параметров нейросети по необходимости
dann_n=neural$normir_dann(neir,dann);
neir=dann_n$neir;ddd=dann_n$dd;dd_all=dann_n$dd_all;rm(dann_n);



#настройка нейросети
#system.time(nastr<-   neural$neir_nastr(ddd,neir,10))
system.time(neir<-neural$neir_nastr_new(ddd,neir,30))
sigma=neir$k$sigma;
#  neir$k$ogr_k=0.2

progn=neural$neir_prognoz(dd_all,neir);dd_prog=dd_all;dd_prog$z=progn$z;dd_prog$zp=progn$zp;
#dd_prog=subset(dd_prog, select = c(Train,Date,Type,Seats,y,z,zp));
#подсчёт итоговых отличий, независимой сверкой
zz=aggregate(x =list(err= (dd_prog$y-dd_prog$z)**2,col=1),by = list(dd_prog$dann,dd_prog$Train), FUN = "sum")
zz$sigma=(zz$err/zz$col)**0.5; #получилось хорошо - совпадает!
#график коррелляции 
plot (x=dd_prog$y,y=dd_prog$z,col=dd_prog$dann)


#запись нейросети в базу истории нейросети, и полную и сокращённую
neir=neural$neir.save_to_hist(neir,NULL);#запись без прогнозов - не ставит глухую активность!

neir=neural$neir.save_to_hist(neir,dd_all);#запись с прогнозами



neir=neural$neir_ispravl(neir,ddd) #ИСПРАВЛЕНИЕ НЕЙРОСЕТИ - ЛИШНИЕ НЕЙРОНы ПРЕОБРАЗОВАТЬ

#поиск диапазонов значений входов внутренних нейронов
rezz=neural$neir_vnutri(neir,ddd)


#   neir$sozd$vhod







